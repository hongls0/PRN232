@model MarathonManager.API.DTOs.MyRegistrationDto

@{
    ViewData["Title"] = "Registration Details";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container" style="padding-top: 80px; padding-bottom: 80px;">

    <!-- Back Button -->
    <div class="mb-3">
        <a asp-controller="Runner" asp-action="Index" asp-route-tab="my-registrations" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to My Registrations
        </a>
    </div>

    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <h1 class="display-5 fw-bold">Registration Details</h1>
            <p class="lead text-muted">Registration ID: #@Model.Id</p>
        </div>
        <div class="col-lg-4 text-lg-end">
            <span class="badge fs-5 @(Model.PaymentStatus == "Paid" ? "bg-success" : Model.PaymentStatus == "Pending" ? "bg-warning text-dark" : "bg-danger")">
                @Model.DisplayStatus
            </span>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Registration Info -->
        <div class="col-lg-8 mb-4">

            <!-- Race Information Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-flag-checkered me-2"></i>Race Information
                    </h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(Model.RaceImageUrl))
                    {
                        <img src="@Model.RaceImageUrl" class="img-fluid rounded mb-3" alt="@Model.RaceName" style="max-height: 250px; width: 100%; object-fit: cover;">
                    }

                    <h4 class="card-title mb-3">@Model.RaceName</h4>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <p class="mb-1">
                                <i class="fas fa-calendar text-primary me-2"></i>
                                <strong>Race Date:</strong>
                            </p>
                            <p class="ms-4">@Model.RaceDate.ToString("dddd, MMMM dd, yyyy")</p>
                        </div>

                        <div class="col-md-6 mb-3">
                            <p class="mb-1">
                                <i class="fas fa-clock text-info me-2"></i>
                                <strong>Start Time:</strong>
                            </p>
                            <p class="ms-4">@Model.StartTime.ToString("hh:mm tt")</p>
                        </div>

                        <div class="col-md-6 mb-3">
                            <p class="mb-1">
                                <i class="fas fa-map-marker-alt text-danger me-2"></i>
                                <strong>Location:</strong>
                            </p>
                            <p class="ms-4">@Model.Location</p>
                        </div>

                        <div class="col-md-6 mb-3">
                            <p class="mb-1">
                                <i class="fas fa-road text-success me-2"></i>
                                <strong>Distance:</strong>
                            </p>
                            <p class="ms-4">@Model.DistanceName (@Model.DistanceInKm km)</p>
                        </div>
                    </div>

                    <div class="text-center mt-3">
                        <a asp-controller="Runner" asp-action="RaceDetails" asp-route-id="@Model.RaceId"
                           class="btn btn-outline-primary">
                            <i class="fas fa-info-circle me-2"></i>View Full Race Details
                        </a>
                    </div>
                </div>
            </div>

            <!-- Registration Status Timeline -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ol me-2"></i>Registration Timeline
                    </h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <!-- Registration Created -->
                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0">
                                <div class="rounded-circle bg-success text-white d-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px;">
                                    <i class="fas fa-check"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">Registration Created</h6>
                                <p class="text-muted mb-0">@Model.RegistrationDate.ToString("MMM dd, yyyy hh:mm tt")</p>
                            </div>
                        </div>

                        <!-- Payment Status -->
                        <div class="d-flex mb-4">
                            <div class="flex-shrink-0">
                                <div class="rounded-circle @(Model.PaymentStatus == "Paid" ? "bg-success" : "bg-warning") text-white d-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px;">
                                    <i class="fas @(Model.PaymentStatus == "Paid" ? "fa-check" : "fa-clock")"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">Payment @Model.PaymentStatus</h6>
                                <p class="text-muted mb-0">
                                    @if (Model.PaymentStatus == "Paid")
                                    {
                                        <span>Payment confirmed</span>
                                    }
                                    else if (Model.PaymentStatus == "Pending")
                                    {
                                        <span>Awaiting payment confirmation</span>
                                    }
                                    else
                                    {
                                        <span>Registration cancelled</span>
                                    }
                                </p>
                            </div>
                        </div>

                        <!-- Race Day -->
                        <div class="d-flex">
                            <div class="flex-shrink-0">
                                <div class="rounded-circle @(Model.RaceDate > DateTime.Now ? "bg-secondary" : "bg-primary") text-white d-flex align-items-center justify-content-center"
                                     style="width: 40px; height: 40px;">
                                    <i class="fas fa-flag-checkered"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="mb-1">Race Day</h6>
                                <p class="text-muted mb-0">
                                    @if (Model.RaceDate > DateTime.Now)
                                    {
                                        var daysUntil = (Model.RaceDate - DateTime.Now).Days;
                                        <span>@daysUntil days remaining</span>
                                    }
                                    else
                                    {
                                        <span>Race completed</span>
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Right Column: Quick Actions & Details -->
        <div class="col-lg-4">

            <!-- Registration Summary Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>Summary
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-6">Registration ID:</dt>
                        <dd class="col-sm-6">#@Model.Id</dd>

                        <dt class="col-sm-6">Registration Fee:</dt>
                        <dd class="col-sm-6"><strong class="text-success">@Model.RegistrationFee.ToString("N0") VNĐ</strong></dd>

                        @if (!string.IsNullOrEmpty(Model.BibNumber))
                        {
                            <dt class="col-sm-6">Bib Number:</dt>
                            <dd class="col-sm-6">
                                <span class="badge bg-primary fs-6">@Model.BibNumber</span>
                            </dd>
                        }

                        <dt class="col-sm-6">Payment Status:</dt>
                        <dd class="col-sm-6">
                            <span class="badge @(Model.PaymentStatus == "Paid" ? "bg-success" : "bg-warning text-dark")">
                                @Model.PaymentStatus
                            </span>
                        </dd>

                        <dt class="col-sm-6">Registered On:</dt>
                        <dd class="col-sm-6">@Model.RegistrationDate.ToString("MMM dd, yyyy")</dd>
                    </dl>
                </div>
            </div>

            <!-- Actions Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>Actions
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.PaymentStatus == "Pending")
                    {
                        <form asp-controller="Runner" asp-action="FakePayment" method="post"
                              onsubmit="return confirm('Simulate payment for this registration? This will mark it as Paid and assign a bib number.');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="registrationId" value="@Model.Id" />
                            <button type="submit" class="btn btn-success w-100 mb-2">
                                <i class="fas fa-credit-card me-2"></i>Pay Now (Test Payment)
                            </button>
                        </form>
                    }

                    @if (Model.HasResult)
                    {
                        <a href="#" class="btn btn-primary w-100 mb-2">
                            <i class="fas fa-trophy me-2"></i>View Result
                        </a>
                    }

                    @if (Model.CanCancel)
                    {
                        <form asp-controller="Runner" asp-action="CancelRegistration" method="post"
                              onsubmit="return confirm('Are you sure you want to cancel this registration? This action cannot be undone.');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="registrationId" value="@Model.Id" />
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="fas fa-times-circle me-2"></i>Cancel Registration
                            </button>
                        </form>
                    }
                    else if (Model.PaymentStatus == "Cancelled")
                    {
                        <button class="btn btn-secondary w-100" disabled>
                            <i class="fas fa-ban me-2"></i>Registration Cancelled
                        </button>
                    }
                    else if (!Model.CanCancel && Model.RaceDate < DateTime.Now)
                    {
                        <button class="btn btn-secondary w-100" disabled>
                            <i class="fas fa-check-circle me-2"></i>Race Completed
                        </button>
                    }
                </div>
            </div>

            <!-- Help Card -->
            <div class="card shadow-sm border-info">
                <div class="card-body">
                    <h6 class="card-title">
                        <i class="fas fa-info-circle text-info me-2"></i>Need Help?
                    </h6>
                    <p class="card-text small">
                        If you have any questions about your registration, please contact the race organizer or our support team.
                    </p>
                    <a href="#" class="btn btn-outline-info btn-sm w-100">
                        <i class="fas fa-envelope me-2"></i>Contact Support
                    </a>
                </div>
            </div>

        </div>
    </div>

</div>

<style>
    .timeline {
        position: relative;
    }

        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #dee2e6;
        }
</style>